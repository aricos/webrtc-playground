<!DOCTYPE html>
<html lang="en">
  <head>
    <title>webrtc playground</title>
    
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="css/devices.css">
    <style>
      body
      {
        font-family: Helvetica, Arial, Sans-Serif;
        font-size: 14px;
        background-color: #372924;
      }
      
      h2, h3, h4, h5, h6
      {
        font-weight: lighter;
      }      
      
      .main-nav
      {
        background-color: #5E453C;
        position: absolute;
        border: 1px solid #D59884;
        top: 1em;
        right: 25%;
        left: 1em;
        padding: 0.5em 0.5em;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 6px;
      }
      
    </style>
  </head>

  <body>

    <header class="main-nav">
      <nav>
        <button onclick="startVideoConnection()">Start Video Connection</button>
      </nav>
    </header>
    
    
    <section class="capture-devices">
      <article id="local-device" class="capture-device">
        <header>
          <h4>Your Device</h4>
        </header>
        <video id="captureVideo" autoplay></video>
        <nav>
          <button data-command="audio.toggle">Toggle Audio</button>
          <button data-command="video.toggle">Toggle Video</button>
        </nav>
      </article>
    </section>
    
    

    <br />
    <video id="localVideo" autoplay muted style="width:30%;"></video>
    <video id="remoteVideo" autoplay style="width:30%;"></video>
    <input type="button" id="start" onclick="start(true)" value="Start Video"></input>


    <section class="chat">
      <header>
        <h3>Message</h3>
      </header>
      <section id="chat-messages" class="messages">
      </section>
      <footer>
        <form id="chat-form">
        <textarea name="body"></textarea>
        <button>Send</button>
        </form>
      </footer>
    </section>


    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="websocket.js"></script>
    <script src="webrtc.js"></script>
    <script src="room.js"></script>
    <script src="chat.js"></script>    
    <script src="device.js"></script>        
    <script type="text/javascript">
          

      // Room
      
      var roomSettings = {}
      
      if (typeof localStorage !== "undefined")
      {
        roomSettings.uid = localStorage["room.uid"]
      }
      
      var room = createRoom(roomSettings)
      
      room.onconnect = function()
      {
        pageReady(room)
      }
      
      room.onclose = function()
      {
        
      }
      
      room.onmessage = function(msg)
      { 
        chatMessages.push(msg)
      }
      
      room.oninvitation = function(command)
      {
        if (command.sender === room.uid)
        {
          return
        }
        
        joinVideoConnection(command)
      }
      
      room.onicecandidate = function(command)
      {
        // joinVideoConnection(command)
      }
      
      room.oncommand = function(command)
      { 
        // gotMessageFromServer(command)
        
        console.log(command)
        
        
        switch (command.cmd)
        {
        default:
          break
        }
      }
      
      room.onchange = function(message)
      {
        if (room.uid)
        {
          if (typeof localStorage !== "undefined")
          {
            localStorage["room.uid"] = room.uid
          }
          
          localDevice.dataset.deviceUid = room.uid
        }
      }
      
      
      // Device Grid
      
      var devices = document.querySelector(`.capture-devices`)
      
      var localDevice = document.querySelector("#local-device")
      
      var deviceTemplate = localDevice.cloneNode(true)
      
      var deviceControllers = {}
      
      room.onoperatorjoin = function(operator)
      {         
        var devices = document.querySelector(`.capture-devices`)
        
        var operatorElement = devices.querySelector(`[data-device-uid='${operator.uid}']`)
        
        if (!operatorElement)
        {
          operatorElement = deviceTemplate.cloneNode(true)
            
          var operatorDevice = new CaptureDevice(operator.uid, CaptureDevice.REMOTE)
          
          var controller = new DeviceController(operatorDevice, operatorElement)
          
          controller.setUp()
          
          deviceControllers[operator.uid] = controller
          
          devices.appendChild(operatorElement)
        }
        
        operatorElement.classList.add("active")
      }
      
      room.onoperatorleave = function(operator)
      {        
        var operatorElement = devices.querySelector(`[data-device-uid='${operator.uid}']`)
        
        if (!operatorElement)
        {
          return
        }
        
        operatorElement.classList.remove("active")
      }
      
      room.onready = function(command)
      {
        chatMessages.userUid = room.uid
      }
      
      
      // Media Device
      
      var mediaTypes = {
        video: true,
        audio: true
      }
      
      var captureDevice = new CaptureDevice()
      
      var captureDeviceController = new DeviceController(captureDevice, document.querySelector("#local-device"))
      
      captureDevice.setUpMedia(mediaTypes, function(err)
      {
        if (err)
        {
          return
        }
        
        captureDeviceController.setUp()    
      })
      
      
      // Video Session
      
      var videoPeerConnectionConfig = {
        "iceServers": [
          {
            "urls": "stun:stun.stunprotocol.org:3478"
          },
          
          {
            "urls": "stun:stun.l.google.com:19302"
          }
        ]
      }
      
      var videoPeerConnection
      
      function receivedIceCandidate(event) 
      {
        if (event.candidate != null) 
        {
          room.sendCommand("videosession.icecandidate", {
            "ice": event.candidate, 
            "uuid": room.uid
          })
          // room.socket.send(JSON.stringify({'ice': event.candidate, 'uuid': uuid}));
        }
      }
      
      function receivedRemoteStream(event)
       {
        console.log('got remote stream', event)
        // debuggers
        // remoteVideo.srcObject = event.streams[0];
      }
      
      
      function startVideoConnection()
      {      
        videoPeerConnection = new RTCPeerConnection(videoPeerConnectionConfig)
        videoPeerConnection.onicecandidate = receivedIceCandidate
        videoPeerConnection.ontrack = receivedRemoteStream
        videoPeerConnection.addStream(captureDevice.mediaStream)

        videoPeerConnection.createOffer().then(setDescription).catch(errorHandler)
        
        // callbacks
        
        function setDescription(description)
        {
          videoPeerConnection.setLocalDescription(description)
                             .then(reportOffer)
                             .catch(errorHandler)
        }
        
        function reportOffer()
        {
          {
            room.sendCommand("videosession.start", {
              "sdp": videoPeerConnection.localDescription, 
              "uuid": room.uid
            })
          }
        }
        
        function errorHandler(error)
        {
          alert("Failed to start video connection:\n" + error)
          
          console.error("error", arguments)
        }
      }
      
      function joinVideoConnection(command)
      {
        if (command.sender === room.uid)
        {
          
        }

        videoPeerConnection = new RTCPeerConnection(videoPeerConnectionConfig)
        videoPeerConnection.onicecandidate = receivedIceCandidate
        videoPeerConnection.ontrack = receivedRemoteStream
        videoPeerConnection.addStream(captureDevice.mediaStream)
        
        // Ignore messages from ourself
        if (command.sender === room.uid)
        {
          return
        }

        if (command.sdp) 
        {
          var description = new RTCSessionDescription(command.sdp)
          
          videoPeerConnection.setRemoteDescription(description).then(function()
          {
            // Only create answers in response to offers
            if (command.sdp.type === "offer")
            {
              videoPeerConnection.createAnswer().then(setDescription).catch(errorHandler)
            }
          }).catch(errorHandler)
        } 
        
        else if (command.ice) 
        {
          videoPeerConnection.addIceCandidate(new RTCIceCandidate(command.ice)).catch(errorHandler)
        }
        

        // callbacks
        
        function setDescription(description)
        {
          videoPeerConnection.setLocalDescription(description)
                             .then(reportOffer)
                             .catch(errorHandler)
        }
        
        function reportOffer()
        {
          {
            room.sendCommand("videosession.start", {
              "sdp": videoPeerConnection.localDescription, 
              "uuid": room.uid
            })
          }
        }
        
        function errorHandler(error)
        {
          alert("Failed to join video connection:\n" + error)
          
          console.error("error", arguments)
        }
      }
            
      
      // Chat
      
      var chatInput = new ChatInputController(document.querySelector("#chat-form"))
      
      var chatMessages = new ChatMessagesController(document.querySelector("#chat-messages"))
            
      chatInput.onmessage = function(message)
      {
        room.sendMessage(message)
      }
      
      
      // App Boot
      
      document.addEventListener("DOMContentLoaded", function()
      {
        room.connect()
      })
    </script>
  </body>
</html>