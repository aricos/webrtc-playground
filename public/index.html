<!DOCTYPE html>
<html lang="en">
  <head>
    <title>webrtc playground</title>
    
    <link rel="stylesheet" href="css/chat.css">
    <style>
      body
      {
        font-family: Helvetica, Arial, Sans-Serif;
        font-size: 14px;
        background-color: #372924;
      }
      
      .capture-device
      {
        position: relative;
        display: inline-block;
        width: 22%;
        margin: 1%;
        height: auto;
        background-color: #75554A;
        border-radius: 6px;
        color: #FFF;
        opacity: 0.5;
        transform: opacity 0.15 linear;
      }
      
      .capture-device.active
      {
        opacity: 1;
      }
      
      .capture-device video
      {
        width: 100%;
        height: auto;
        padding: 0;
        margin: 0;
        background-color: #563F37;
      }

      .capture-device header
      {
        padding: 0;
        margin: 0;
      }
      
      .capture-device header h4
      {
        padding: 0;
        margin: 1em;
      }
      
      .capture-device nav
      {
        right: 0;
        bottom: 0;
        left: 0;
        padding: 0.4em 0.2em 1em 0.2em;
/*        background-color: rgba(255, 255, 255, 0.6);*/
        text-align: center;
      }
      
      .capture-device nav button
      {
        display: inline-block;
        background-color: #956B5D;
        color: #FFF;
        border: none;
        border-radius: 5px;
        padding: 0.8em 1em;
      }
      
      .capture-device nav button 
      {
          outline: none;
          border: none;
      }
      

      /** Devices Listing */
      
      .capture-devices
      {
        background-color: #956B5D;
        position: absolute;
        border: 1px solid #D59884;
        top: 1em;
        right: 25%;
        bottom: 1em;
        left: 1em;
        padding: 0 0 3em 0;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 6px;
      }
      
    </style>
  </head>

  <body>

    
    
    <section class="capture-devices">
      <article id="local-device" class="capture-device">
        <header>
          <h4>Local Device</h4>
        </header>
        <video id="captureVideo" autoplay></video>
        <nav>
          <button data-command="audio.toggle">Toggle Audio</button>
          <button data-command="video.toggle">Toggle Video</button>
        </nav>
      </article>
    </section>
    
    

    <br />
    <video id="localVideo" autoplay muted style="width:30%;"></video>
    <video id="remoteVideo" autoplay style="width:30%;"></video>
    <input type="button" id="start" onclick="start(true)" value="Start Video"></input>


    <section class="chat">
      <header>
        <h3>Chat</h3>
      </header>
      <section id="chat-messages" class="messages">
      </section>
      <footer>
        <form id="chat-form">
        <textarea name="body"></textarea>
        <button>Send</button>
        </form>
      </footer>
    </section>


    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="websocket.js"></script>
    <script src="webrtc.js"></script>
    <script src="room.js"></script>
    <script src="chat.js"></script>    
    <script src="device.js"></script>        
    <script type="text/javascript">
          

      // Room
      
      var roomSettings = {}
      
      if (typeof localStorage !== "undefined")
      {
        roomSettings.uid = localStorage["room.uid"]
      }
      
      var room = createRoom(roomSettings)
      
      room.onconnect = function()
      {
        pageReady(room)
      }
      
      room.onclose = function()
      {
        
      }
      
      room.onmessage = function(msg)
      { 
        chatMessages.push(msg)
      }
      
      room.oncommand = function(command)
      { 
        gotMessageFromServer(command)
      }
      
      room.onchange = function(message)
      {
        if (room.uid)
        {
          if (typeof localStorage !== "undefined")
          {
            localStorage["room.uid"] = room.uid
          }
          
          localDevice.dataset.deviceUid = room.uid
        }
      }
      
      
      // Device Grid
      
      var devices = document.querySelector(`.capture-devices`)
      
      var localDevice = document.querySelector("#local-device")
      
      var deviceTemplate = localDevice.cloneNode(true)
      
      var deviceControllers = {}
      
      room.onoperatorjoin = function(operator)
      {         
        var devices = document.querySelector(`.capture-devices`)
        
        var operatorElement = devices.querySelector(`[data-device-uid='${operator.uid}']`)
        
        if (!operatorElement)
        {
          operatorElement = deviceTemplate.cloneNode(true)
            
          var operatorDevice = new CaptureDevice(operator.uid, CaptureDevice.REMOTE)
          
          var controller = new DeviceController(operatorDevice, operatorElement)
          
          controller.setUp()
          
          deviceControllers[operator.uid] = controller
          
          devices.appendChild(operatorElement)
        }
        
        operatorElement.classList.add("active")
      }
      
      room.onoperatorleave = function(operator)
      {        
        var operatorElement = devices.querySelector(`[data-device-uid='${operator.uid}']`)
        
        if (!operatorElement)
        {
          return
        }
        
        operatorElement.classList.remove("active")
      }
      
      room.onready = function(command)
      {
        chatMessages.userUid = room.uid
      }
      
      
      // Media Device
      
      var mediaTypes = {
        video: true,
        audio: true
      }
      
      var captureDevice = new CaptureDevice()
      
      var captureDeviceController = new DeviceController(captureDevice, document.querySelector("#local-device"))
      
      captureDevice.setUpMedia(mediaTypes, function(err)
      {
        if (err)
        {
          return
        }
        
        captureDeviceController.setUp()    
      })
            
      
      // Chat
      
      var chatInput = new ChatInputController(document.querySelector("#chat-form"))
      
      var chatMessages = new ChatMessagesController(document.querySelector("#chat-messages"))
            
      chatInput.onmessage = function(message)
      {
        room.sendMessage(message)
      }
      
      
      // App Boot
      
      document.addEventListener("DOMContentLoaded", function()
      {
        room.connect()
      })
    </script>
  </body>
</html>